# currency-bot-api

汇率查询服务技术架构文档
系统组件：Poe Bot + Cloudflare Worker + Frankfurter API + GitHub

1. 在汇率查询服务的技术架构中，Poe Bot、Cloudflare Worker、Frankfurter API和GitHub四者形成了完整的开发部署闭环。  

**Poe Bot**作为用户交互层，接收自然语言查询（如"USD兑CNY过去5年汇率"），将结构化参数通过HTTP请求发送给Cloudflare Worker，并将返回的Markdown数据渲染为可视化表格。  

**Cloudflare Worker**作为无服务器逻辑核心，处理路由验证、参数计算（如动态生成日期范围）和缓存管理。它调用Frankfurter API获取实时或历史汇率数据，并格式化响应。当配置需要更新时，Worker会通过GitHub的Raw URL动态加载最新货币别名库。  

**Frankfurter API**提供权威的汇率数据源，覆盖1999年至今的主要货币对。Worker通过HTTPS调用其接口，并处理可能的限流或数据缺失异常。  

**GitHub**作为基础设施底座，承担三大职责：一是通过版本控制管理Worker脚本和货币配置；二是利用GitHub Actions实现CI/CD自动化部署（代码推送后自动更新Cloudflare Worker）；三是通过Issue追踪系统记录API异常或功能需求。  

四者通过标准化协议衔接：用户与Poe采用自然语言交互，Poe与Worker通过REST API通信，Worker与GitHub通过HTTPS同步配置，形成高内聚低耦合的架构。GitHub的版本控制保障了迭代可靠性，而Cloudflare的边缘计算能力与Poe的交互灵活性共同提升了服务响应效率。

2. 
---

### **1. Poe Bot 组件**
**核心构成**  
- **自然语言Prompt**：位于Poe Bot的设置面板，定义用户交互指令模板（例如"查询{货币A}到{货币B}的{时间段}汇率"）。  
- **响应模板**：Markdown格式的动态响应结构，使用`{{变量}}`插入实时数据（如`{{year}}`代表年份）。  
- **Webhook配置**：将用户请求转发至Cloudflare Worker的HTTP端点（通常在Poe的Bot连接设置中配置）。  

**维护方法**  
- 更新Prompt：登录Poe开发者后台直接编辑Instructions，注意保留变量占位符。  
- 修改响应样式：调整Markdown模板的排版，例如添加分隔线或调整表格列宽。  

---

### **2. Cloudflare Worker 组件**  
**核心文件**  
- `index.js`：包含主业务逻辑，处理路由分发、参数验证、API调用和缓存管理。  
- `wrangler.toml`：配置文件，定义环境变量、KV存储绑定和定时任务（如每日数据刷新）。  
- `utils/currency.js`：独立货币处理模块，可替换为从GitHub动态加载。  

**关键功能**  
- 动态计算日期范围（如自动将"过去5年"转换为具体日期区间）。  
- 错误降级处理：当Frankfurter API不可用时返回缓存数据或友好提示。  

**部署流程**  
1. 修改代码后通过`wrangler publish`命令部署。  
2. 紧急回滚可使用`wrangler deployments rollback`。  

---

### **3. Frankfurter API 组件**  
**主要接口**  
- 实时汇率端点 `/latest`：支持`from`和`to`参数查询最新汇率。  
- 历史数据端点 `/{start}..{end}`：获取日期范围内的历史数据（如`/2020-01-01..2025-01-01`）。  
- 货币列表 `/currencies`：查看所有支持的货币代码。  

**维护注意**  
- 免费版限流100次/小时，需监控`429`状态码。  
- 数据更新延迟：节假日数据可能延迟1-2个工作日。  

---

### **4. GitHub 仓库组件**  
**目录结构**  
- `index.js`：Worker主代码，建议通过Pull Request提交变更。  

**协作规范**  
- 提交代码时关联Issue编号（如`git commit -m "fix: #12 修复日期计算"`）。  
- 生产环境变更必须通过`main`分支触发部署。  

---

### **组件交互示例**  
```plaintext
用户询问 
  → Poe Bot转发请求 
    → Cloudflare Worker计算日期并调用API 
      → Frankfurter返回数据 
        → Worker格式化结果 
          → Poe渲染表格 
            → 用户查看响应
```

**如何扩展新功能**  
1. 在GitHub的`config/`目录下新增配置文件（如`crypto_currencies.json`）。  
2. 修改Worker的`index.js`加载新配置。  
3. 更新Poe Bot的Prompt以支持新指令（如"查询比特币价格"）。  

此描述可直接复制到README文档，如需更简洁版本可删除示例部分保留核心说明。


3. 该汇率查询服务架构存在以下潜在缺陷，需在后续维护中重点关注和改进：

---

### **1. 数据源依赖风险**
- **单点故障**：完全依赖Frankfurter API，若服务不可用（如限流、停更）将导致系统瘫痪  
  *改进方案*：  
  - 增加备用数据源（如欧洲央行API）  
  - 实现故障自动切换逻辑  

- **历史数据缺口**：部分货币对（如新兴市场货币）数据起始年份较晚  
  *改进方案*：  
  - 在响应中明确标注实际可用数据范围  
  - 对缺失数据区间返回友好提示  

---

### **2. 动态日期计算的边界问题**
- **时区处理不一致**：未显式处理UTC与本地时区差异，可能导致日期偏移  
  *示例问题*：  
  ```javascript
  // 当前逻辑可能因时区产生1天误差
  new Date('2025-06-20').toLocaleDateString('zh-CN') // 在UTC-8时区显示为"2025/6/19"
  ```
  *改进方案*：  
  - 强制所有日期计算使用UTC标准  
  - 在API请求和响应中明确时区说明  

- **闰秒/夏令时异常**：极端时间场景下可能出现计算错误  
  *改进方案*：  
  - 引入moment.js等专业时间库处理复杂日期逻辑  

---

### **3. 安全风险**

- **注入攻击**：未对用户输入的货币符号做严格过滤  
  *风险示例*：  
  ```
  /history?from=USD';DROP TABLE--&to=CNY
  ```
  *改进方案*：  
  - 增加参数白名单验证  
  - 使用预处理语句构造API请求  

---

### **4. 性能瓶颈**
- **缓存雪崩**：所有Worker实例共用相同缓存TTL，高峰期可能同时失效  
  *改进方案*：  
  - 为缓存过期时间添加随机抖动（如±10%）  
  - 实现分级缓存（内存+持久化存储）  

- **大范围查询负载**：请求10年以上数据时API响应缓慢  
  *改进方案*：  
  - 限制最大查询范围（如不超过20年）  
  - 分片获取数据并后台聚合  

---

### **5. 可观测性不足**
- **监控缺失**：无法感知API调用失败或异常流量  
  *改进方案*：  
  - 集成Cloudflare Analytics  
  - 将错误日志推送至GitHub Issues/Sentry  

- **缺乏用户行为分析**：无法优化高频查询场景  
  *改进方案*：  
  - 在Poe Bot中埋点统计常用货币对  

---

### **6. 扩展性限制**
- **货币对管理僵化**：新增货币需手动更新CURRENCY_ALIAS字典  
  *改进方案*：  
  - 改用数据库存储货币配置  
  - 开发管理后台支持动态配置  

- **多语言支持薄弱**：响应文本硬编码为中文  
  *改进方案*：  
  - 根据Poe Bot用户语言设置动态切换文案  

---

### **后续维护优先级建议**
1. **立即修复**：安全风险（配置泄露/注入攻击）  
2. **短期优化**：时区处理 + 缓存策略改进  
3. **长期规划**：多数据源容灾 + 监控体系搭建  

通过持续迭代可逐步构建更健壮的服务，建议建立每季度架构评审机制。

